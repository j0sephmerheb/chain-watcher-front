name: Build & Deploy Angular

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      - name: Build
        run: npm run build

      - name: Archive build
        run: |
          tar -C dist -czf angular-dist.tgz .
      - uses: actions/upload-artifact@v4
        with:
          name: angular-dist
          path: angular-dist.tgz

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: angular-dist
          path: .

      - name: Copy build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "angular-dist.tgz"
          target: "/tmp/"

      - name: Deploy static files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            WEB_ROOT="${{ secrets.ANGULAR_WEB_ROOT }}"   # e.g. /var/www/your-site
            sudo mkdir -p "$WEB_ROOT"
            sudo tar -xzf /tmp/angular-dist.tgz -C "$WEB_ROOT" --strip-components=1
            # (Optional) touch reload for Nginx if you use it via auto-reload
            if command -v nginx >/dev/null 2>&1; then sudo nginx -t && sudo systemctl reload nginx; fi
